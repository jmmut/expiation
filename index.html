<!DOCTYPE HTML>
<html lang="es">

<head>
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
  <meta content="utf-8">
  <title>Expiación</title>
  <link rel="icon" href="data:,"> <!-- don't ask for favicon -->
  <style>
    div,
    p,
    button {
      /*font-size: 15px;*/
      text-align: left;
      margin-left: 15%;
      margin-right: 15%;
    }
    .question {
      margin-left: 0%;
      margin-right: 0%;
    }
    .answer {
      margin-left: 20%;
      margin-right: 20%;
    }
    label, li {
      /*font-size: 15px;*/
    }
    h2 {
      text-align: center;
    }
    body {
      background-color: #bbbbbb;
      color: #000000;
    }
    
  </style>
</head>

<body>
  <div id="explanation_div">
    <h2>
      Parte 1: Vergüenza
    </h2>
  </div>
  <div id=questions>
  </div>
<!--


positive direction is bottom right, south west

I is the initial node, "0,0,0" (l,x,y; change in "x" is a horizontal change, "y" vertical, "l" is for level)
F is the final node of each level

-XOX-
-OIO-
---F-

--F--
--X--
FXI--

-->

  <script>
    const graph = {
      "0,0,0": {question: "Estás en una sala con dos puertas. Hay una brújula pintada en suelo.", answers: [
        {answer: "Ir por la puerta al oeste ←", jump: "0,-1,0"},
        {answer: "Ir por la puerta al este →", jump: "0,1,0"},
      ]},
      "0,-1,0": {question: "En esta sala hay dos puertas también. ¿Por qué no hay ventanas? Lo último que recuerdas es que estabas conduciendo.", answers: [
        {answer: "Ir por la puerta al este →", jump: "0,0,0"},
        {answer: "Ir por la puerta al norte ↑", jump: "0,-1,-1"},
      ]},
      "0,-1,-1": {question: "En esta sala hay un cuadro de aquella vez que empujaste a tu pareja en una discusión. Eras más feliz cuando no te acordabas de esto. Duele recordarlo. Hay unos cuantos maniquíes puestos como si mirasen al cuadro. Son maniquíes, pero te molesta que miren la imagen.", answers: [
        {answer: "Ir por la puerta al este →", jump: "0,0,-1"},
        {answer: "Ir por la puerta al sur ↓", jump: "0,-1,0"},
      ]},
      "0,0,-1": {question: "En la pared del norte hay un móvil reproduciendo una voz por el altavoz. Se oye a alguien llorar. La voz te suena pero no acabas de identificar quién es.", answers: [
        {answer: "Ir por la puerta al oeste ←", jump: "0,-1,-1"},
        {answer: "Ir por la puerta al este →", jump: "0,1,-1"},
      ]},
      "0,1,-1": {question: "Este lugar te hace sentirte a solas. Ahora te gustaría estar con tu pareja, pero este lugar no te deja irte.", answers: [
        {answer: "Ir por la puerta al oeste ←", jump: "0,0,-1"},
        {answer: "Ir por la puerta al sur ↓", jump: "0,1,0"},
      ]},
      "0,1,0": {question: "El suelo es de un color diferente aquí. Ves que tienes barro en los zapatos. Ves que también tienes barro en los pantalones y la camisa.", answers: [
        {answer: "Ir por la puerta al oeste ←", jump: "0,0,0"},
        {answer: "Ir por la puerta al norte ↑", jump: "0,1,-1"},
        {answer: "Ir por la puerta al sur ↓", jump: "0,1,1"},
      ]},
      "0,1,1": {question: "Al oeste ← hay escaleras que bajan hasta una puerta más grande y decorada.",
          effect: function() {
            document.getElementById("explanation_div").innerHTML = "<h2>Parte 1: Vergüenza</h2>"
          },
        answers: [
          {answer: "Bajar las escaleras y entrar por la puerta del oeste ←", jump: "1,0,1", condition: part_1_complete},
          {answer: "Ir por la puerta al norte ↑", jump: "0,1,0"},
        ]
      },
      "1,0,1": {question: "Aquí hay dos pasillos. Por el del oeste se oyen ratas y gritos de niños, y el del norte parece un laberinto.",
        effect: function() {
          document.getElementById("explanation_div").innerHTML = "<h2>Parte 2: Debilidad</h2>"
        },
        answers: [
          {answer: "Si hay niños por el oeste hay que ayudarles ←", jump: "end"},
          {answer: "Seguro que los gritos son una trampa. El laberinto al norte es más seguro ↑", jump: "end"},
          {answer: "Subir por el este →", jump: "0,1,1"}
        ]
      },

      "end": {question: "Despiertas. Estás en el barro. Oyes sirenas de ambulancia. Ves que tu pareja está contigo, y no le ha pasado nada. Tu cuerpo te duele por todas partes pero sientes un profundo alivio.",
        effect: function() {
          document.getElementById("explanation_div").innerHTML = "<h2>Parte Final: Expiación</h2>"
        },
        answers: []
      },
    };
    const key_rooms = ["0,-1,-1", "0,1,-1"];
    let visited_rooms = {};

    function get_question(id) {
      return graph[id]?.question;
    }
    function get_answers(id) {
      return graph[id]?.answers;
    }
    function run_effect(id) {
      let effect = graph[id].effect;
      if (effect !== undefined) {
        effect()
      }
    }

    function part_1_complete() {
      // return true; // TODO: remove cheat
      for (const key_room of key_rooms) {
        if (!(key_room in visited_rooms)) {
          console.log("room " + key_room + " was not visited");
          return false;
        }
      }
      return true;
    }

    function add_question(id, parent) {
      answers = get_answers(id);
      if (answers === undefined) {
        console.log("broken jump to id: " + id);
        const question = parent.appendChild(document.createElement("div"));
        question.appendChild(document.createElement('p')).innerHTML = "Logro desbloqueado: Has encontrado una puerta que no lleva a ninguna parte! Cuéntale tu hazaña al programador de este juego en <a href=https://github.com/jmmut/cabezazo/issues/new>https://github.com/jmmut/cabezazo/issues/new</a>, y dile que la sala '" + id + "' no existe";
      } else {
        visited_rooms[id] = 1;
        run_effect(id);
        const question = parent.appendChild(document.createElement("div"));
        question.className = "question";
        question.appendChild(document.createElement('p')).innerHTML = get_question(id);
        for (const {answer, jump, condition} of answers) {
          if (condition === undefined || condition()) {
            add_radio_to(question, id, answer, (event) => {
              remove_later_questions(parent);
              add_question(jump, parent);
            });
          }
        }
      }
    }

    function remove_later_questions(question) {
      Array.from(question.children).forEach(element => {
        if (element.className === "question") {
          element.remove();
        }
      });
    }

    function add_radio_to(parent, radios_id, text, onClick) {
      let alternative = parent.appendChild(document.createElement("div"));
      alternative.className = "answer"
      let input = alternative.appendChild(document.createElement("input"));
      input.type = "radio";
      input.name = text;
      input.id = text;
      input.value = text;
      input.addEventListener("change", onClick);

      const label = alternative.appendChild(document.createElement("label"));
      label.htmlFor = text; // pointing to input.id
      label.innerHTML = text;
      label.addEventListener("change", onClick);
    }

    add_question("0,0,0", document.getElementById("questions"));
  </script>
</body>
